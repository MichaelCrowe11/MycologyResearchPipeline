{% extends "base.html" %}

{% block title %}Image Analysis - Mycology Research Pipeline{% endblock %}

{% block extra_css %}
<style>
    .preview-container {
        position: relative;
        width: 100%;
        height: 300px;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        background-color: var(--bg-secondary);
    }
    
    .preview-container.has-image {
        border-style: solid;
    }
    
    .preview-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    .upload-message {
        text-align: center;
        padding: 20px;
        font-size: 1.1rem;
    }
    
    .upload-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--text-muted);
    }
    
    .species-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .species-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }
    
    .confidence-bar {
        height: 8px;
        border-radius: 4px;
    }
    
    .analysis-container {
        height: 0;
        overflow: hidden;
        transition: height 0.5s ease;
    }
    
    .analysis-container.active {
        height: auto;
    }
    
    .loading-spinner {
        display: none;
    }
    
    .loading .loading-spinner {
        display: inline-block;
    }
    
    .result-section {
        display: none;
    }
    
    .classification-results {
        margin-top: 2rem;
    }
    
    .morphology-section {
        margin-top: 2.5rem;
    }
    
    .color-palette {
        display: flex;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    
    .color-swatch {
        width: 50px;
        height: 50px;
        border-radius: 4px;
        margin-right: 8px;
        border: 1px solid var(--border-color);
    }
    
    .metric-box {
        padding: 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.8;
    }
    
    .image-controls {
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center mb-4">
        <div class="col-lg-10">
            <h1 class="mb-4">Image Analysis</h1>
            <p class="lead mb-4">Upload mushroom images for identification and analysis using our computer vision algorithms.</p>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="card">
                <div class="card-body">
                    <form id="uploadForm" method="post" enctype="multipart/form-data" action="{{ url_for('web.image_analysis') }}">
                        <div class="mb-4">
                            <label for="imageFile" class="form-label">Upload an image of a mushroom specimen</label>
                            <div class="preview-container" id="previewContainer">
                                <div class="upload-message" id="uploadMessage">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <p>Drag & drop your image here or click to browse</p>
                                    <p class="text-muted small">Supported formats: JPG, PNG, JPEG (Max: 10MB)</p>
                                </div>
                                <img id="imagePreview" style="display: none;" alt="Preview">
                            </div>
                            <input type="file" class="form-control d-none" id="imageFile" name="image" accept="image/jpeg,image/png,image/jpg">
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Analysis Options</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="identifySpecies" name="identify_species" checked>
                                    <label class="form-check-label" for="identifySpecies">
                                        Species Identification
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="analyzeMorphology" name="analyze_morphology" checked>
                                    <label class="form-check-label" for="analyzeMorphology">
                                        Morphological Analysis
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="analyzeColor" name="analyze_color" checked>
                                    <label class="form-check-label" for="analyzeColor">
                                        Color Analysis
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="analyzeGrowth" name="analyze_growth" checked>
                                    <label class="form-check-label" for="analyzeGrowth">
                                        Growth Stage Analysis
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="additionalNotes" class="form-label">Additional Notes (Optional)</label>
                                <textarea class="form-control" id="additionalNotes" name="notes" rows="4" placeholder="Add any observations or context about the specimen..."></textarea>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-outline-secondary me-md-2" id="resetButton">
                                <i class="fas fa-redo-alt me-2"></i>Reset
                            </button>
                            <button type="submit" class="btn btn-primary" id="analyzeButton">
                                <i class="fas fa-microscope me-2"></i>Analyze Image
                                <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Results -->
    <div class="row justify-content-center mb-4 result-section" id="resultsSection">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Analysis Results</h4>
                </div>
                <div class="card-body">
                    <!-- Classification Results -->
                    <div class="classification-results">
                        <h5>Species Identification</h5>
                        <p class="text-muted">Top matches based on visual characteristics:</p>
                        
                        <div class="row">
                            <!-- Primary Match -->
                            <div class="col-md-6 mb-4">
                                <div class="card species-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="score-circle high-score me-3">
                                                <span id="primaryConfidence">95%</span>
                                            </div>
                                            <div>
                                                <h5 class="mb-0" id="primarySpecies">Amanita muscaria</h5>
                                                <p class="text-muted small mb-0">Primary Match</p>
                                            </div>
                                        </div>
                                        <p class="mb-3" id="primaryDescription">Commonly known as fly agaric, this species is known for its distinctive red cap with white spots.</p>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 95%" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Secondary Match -->
                            <div class="col-md-6 mb-4">
                                <div class="card species-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="score-circle medium-score me-3">
                                                <span id="secondaryConfidence">72%</span>
                                            </div>
                                            <div>
                                                <h5 class="mb-0" id="secondarySpecies">Amanita pantherina</h5>
                                                <p class="text-muted small mb-0">Secondary Match</p>
                                            </div>
                                        </div>
                                        <p class="mb-3" id="secondaryDescription">Commonly known as the panther cap, this mushroom has a brown to olive-brown cap with white warts.</p>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: 72%" aria-valuenow="72" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Morphology Analysis -->
                    <div class="morphology-section">
                        <h5>Morphological Analysis</h5>
                        <p class="text-muted">Key measurements and characteristics:</p>
                        
                        <div class="row">
                            <div class="col-md-3 mb-4">
                                <div class="card metric-box">
                                    <div class="metric-value" id="capDiameter">10.2 cm</div>
                                    <div class="metric-label">Cap Diameter</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-4">
                                <div class="card metric-box">
                                    <div class="metric-value" id="stemHeight">12.5 cm</div>
                                    <div class="metric-label">Stem Height</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-4">
                                <div class="card metric-box">
                                    <div class="metric-value" id="stemWidth">2.1 cm</div>
                                    <div class="metric-label">Stem Width</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-4">
                                <div class="card metric-box">
                                    <div class="metric-value" id="capShape">Convex</div>
                                    <div class="metric-label">Cap Shape</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Color Analysis -->
                    <div class="color-section">
                        <h5>Color Analysis</h5>
                        <p class="text-muted">Dominant colors and distribution:</p>
                        
                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Cap Colors</h6>
                                        <div class="color-palette" id="capColorPalette">
                                            <div class="color-swatch" style="background-color: #B22222;"></div>
                                            <div class="color-swatch" style="background-color: #CD5C5C;"></div>
                                            <div class="color-swatch" style="background-color: #F5F5F5;"></div>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                            <div class="progress-bar bg-light" role="progressbar" style="width: 40%" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="small text-muted">Red (60%), White (40%)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Stem & Gills Colors</h6>
                                        <div class="color-palette" id="stemColorPalette">
                                            <div class="color-swatch" style="background-color: #F5F5F5;"></div>
                                            <div class="color-swatch" style="background-color: #E8E8E8;"></div>
                                            <div class="color-swatch" style="background-color: #D3D3D3;"></div>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-light" role="progressbar" style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
                                            <div class="progress-bar bg-secondary" role="progressbar" style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="small text-muted">White (90%), Light Gray (10%)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Growth Stage Analysis -->
                    <div class="growth-section">
                        <h5>Growth Stage Analysis</h5>
                        <p class="text-muted">Estimated growth stage and maturity:</p>
                        
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Development Stage</h6>
                                            <span class="badge bg-success" id="growthStage">Mature</span>
                                        </div>
                                        <div class="progress mb-3">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <p class="small mb-0" id="growthDescription">This specimen is in its mature stage with fully developed cap and gills. The cap has expanded to reveal gills underneath and spores are likely being released. The veil has separated from the cap edge.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="mb-3">Growth Timeline</h6>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Button</span>
                                            <span>Egg</span>
                                            <span>Expansion</span>
                                            <span>Mature</span>
                                            <span>Old</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-secondary" role="progressbar" style="width: 20%"></div>
                                            <div class="progress-bar bg-info" role="progressbar" style="width: 20%"></div>
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 20%"></div>
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 20%"></div>
                                            <div class="progress-bar bg-light" role="progressbar" style="width: 20%"></div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between">
                                                <span>Current stage</span>
                                                <span id="daysToHarvest">Optimal for harvest</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" class="btn btn-outline-secondary me-md-2" id="downloadReportBtn">
                            <i class="fas fa-download me-2"></i>Download Report
                        </button>
                        <button type="button" class="btn btn-primary" id="saveToCollectionBtn">
                            <i class="fas fa-save me-2"></i>Save to Collection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const previewContainer = document.getElementById('previewContainer');
        const uploadMessage = document.getElementById('uploadMessage');
        const imagePreview = document.getElementById('imagePreview');
        const imageFileInput = document.getElementById('imageFile');
        const resetButton = document.getElementById('resetButton');
        const analyzeButton = document.getElementById('analyzeButton');
        const uploadForm = document.getElementById('uploadForm');
        const resultsSection = document.getElementById('resultsSection');
        
        // Handle click on preview container
        previewContainer.addEventListener('click', function() {
            imageFileInput.click();
        });
        
        // Handle drag and drop
        previewContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            previewContainer.classList.add('border-primary');
        });
        
        previewContainer.addEventListener('dragleave', function() {
            previewContainer.classList.remove('border-primary');
        });
        
        previewContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            previewContainer.classList.remove('border-primary');
            
            if (e.dataTransfer.files.length) {
                imageFileInput.files = e.dataTransfer.files;
                updatePreview(e.dataTransfer.files[0]);
            }
        });
        
        // Handle file selection
        imageFileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                updatePreview(this.files[0]);
            }
        });
        
        // Reset button
        resetButton.addEventListener('click', function() {
            resetForm();
        });
        
        // Analyze button - form submission
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!imageFileInput.files || !imageFileInput.files[0]) {
                alert('Please select an image first');
                return;
            }
            
            // For demo purposes, simulate processing
            analyzeButton.classList.add('loading');
            analyzeButton.disabled = true;
            
            setTimeout(function() {
                analyzeButton.classList.remove('loading');
                analyzeButton.disabled = false;
                resultsSection.style.display = 'block';
                
                // Scroll to results
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }, 1500);
            
            // In a real implementation, we would submit the form here
            // uploadForm.submit();
        });
        
        // Download report button
        document.getElementById('downloadReportBtn').addEventListener('click', function() {
            alert('Report download feature will be available in the full version');
        });
        
        // Save to collection button
        document.getElementById('saveToCollectionBtn').addEventListener('click', function() {
            alert('Results saved to your collection');
        });
        
        // Helper function to update preview
        function updatePreview(file) {
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File size exceeds 10MB limit');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                uploadMessage.style.display = 'none';
                previewContainer.classList.add('has-image');
            };
            
            reader.readAsDataURL(file);
        }
        
        // Helper function to reset form
        function resetForm() {
            imageFileInput.value = '';
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            uploadMessage.style.display = 'block';
            previewContainer.classList.remove('has-image');
            resultsSection.style.display = 'none';
        }
    });
</script>
{% endblock %}